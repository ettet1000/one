#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

GAMES=(wow trap rope)

function build {
  export GAME="$1"
  echo "Building $GAME"
  rm -rf "www/${GAME}"
  mkdir "www/${GAME}"
  echo "import main from './src/${GAME}.js'; main();" | npx rollup -c rollup.mjs
  node process.mjs
  rm -f "www/${GAME}/bundle.js"
  echo "optimizing PNGs..."
  optipng -quiet www/${GAME}/*.png
}

function rebuild {
  rm -rf www/
  mkdir www/
  buildall
}

function buildall {
  \cp page.html www/index.html
  \cp icon.png www/

  for g in ${GAMES[@]}; do
    if [ ! -d "www/$g" ]; then
      build "$g"
    else
      echo "Skipping $g"
    fi
  done
}

function sync {
  buildall
  rsync -a --partial --progress www/ metaphora.co:one/
}

function update-deps {
  yarn upgrade-interactive --latest
  rollup -c planck.rollup.js
}

function help {
  echo "$0 <task> <args>"
  echo "Tasks:"
  compgen -A function | grep -v "^_" | cat -n
}

TIMEFORMAT="Task completed in %3lR"
time "${@:-help}"