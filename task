#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

GAMES=(wow trap rope)
DOJS13K=true

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

function js13k {
  echo "JS13K Packing..."
  advzip -4 -i 100 -a www/${GAME}/pack.zip www/${GAME}/index.html
  PRESIZE=`cat www/${GAME}/index.html | wc -c`
  ZIPSIZE=`cat www/${GAME}/pack.zip | wc -c`
  printf "Final size: ${PRESIZE} -> ${YELLOW}${ZIPSIZE}${NC}\n"
  if (( $ZIPSIZE > 13312 )); then
    printf "ðŸš¨ ${RED}Pack too big for JS13K${NC} ðŸš¨\n"
  fi
}

function build {
  export GAME="$1"
  echo "Building $GAME"
  rm -rf "www/${GAME}"
  mkdir "www/${GAME}"
  echo "import main from './src/${GAME}.js'; main();" | \
    npx rollup -c rollup.mjs -o 'www/${GAME}/bundle.js'
  node process.mjs
  if [ $DOJS13K = true ]; then
    js13k
  else
    PRESIZE=`cat www/${GAME}/index.html | wc -c`
    GZIPSIZE=`gzip -9 -c www/${GAME}/index.html | wc -c`
    printf "Final size: ${PRESIZE} -> ${YELLOW}${GZIPSIZE}${NC}\n"
  fi
  # rm -f "www/${GAME}/bundle.js"
  echo "optimizing PNGs..."
  optipng -quiet www/${GAME}/*.png
}

function rebuild {
  rm -rf www/
  mkdir www/
  buildall
}

function buildall {
  \cp page.html www/index.html
  \cp icon.png www/

  for g in ${GAMES[@]}; do
    if [ ! -d "www/$g" ]; then
      build "$g"
    else
      echo "Skipping $g"
    fi
  done
}

function sync {
  buildall
  rsync -a --partial --progress www/ metaphora.co:one/
}

function update-deps {
  yarn upgrade-interactive --latest
  rollup -c planck.rollup.js
}

function help {
  echo "$0 <task> <args>"
  echo "Tasks:"
  compgen -A function | grep -v "^_" | cat -n
}

TIMEFORMAT="Task completed in %3lR"
time "${@:-help}"
